// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models (JWT Strategy)
// When using JWT strategy, we only need Account and User models
// Session and VerificationToken are not required
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id            String     @id @default(cuid())
  name          String?
  email         String?    @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  roles         UserRole[] @default([USER])

  // E-commerce relations
  cart         Cart?
  orders       Order[]
  reviews      Review[]
  addresses    Address[]
  wishlistItems WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// E-commerce Models

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?    @db.Text
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
  @@index([name])
}

model Product {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  description    String?  @db.Text
  price          Decimal  @db.Decimal(10, 2) // Validate in application: >= 0
  compareAtPrice Decimal? @db.Decimal(10, 2) // Validate in application: >= 0
  costPrice      Decimal? @db.Decimal(10, 2) // Validate in application: >= 0
  sku            String?  @unique
  barcode        String?

  // Inventory
  trackInventory    Boolean @default(true)
  stockQuantity     Int     @default(0) // Validate in application: >= 0
  lowStockThreshold Int? // Validate in application: >= 0

  // Shipping (optional, for shipping cost calculation)
  weight           Decimal? @db.Decimal(10, 2) // in kg, validate: >= 0
  length           Decimal? @db.Decimal(10, 2) // in cm, validate: >= 0
  width            Decimal? @db.Decimal(10, 2) // in cm, validate: >= 0
  height           Decimal? @db.Decimal(10, 2) // in cm, validate: >= 0
  requiresShipping Boolean  @default(true) // false for digital products

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Relations
  categoryId    String?
  category      Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images        ProductImage[]
  variants      ProductVariant[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       Review[]
  wishlistItems WishlistItem[]

  // SEO
  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([stockQuantity])
  @@index([name])
  @@index([sku])
  @@index([requiresShipping])
  @@index([categoryId, isActive])
}

model ProductImage {
  id        String  @id @default(cuid())
  url       String
  alt       String?
  position  Int     @default(0)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([productId, position])
  @@index([productId])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name    String
  sku     String?  @unique
  barcode String?
  price   Decimal? @db.Decimal(10, 2) // Validate in application: >= 0

  // Inventory
  stockQuantity Int @default(0) // Validate in application: >= 0

  // Variant options (e.g., "Size: Large, Color: Blue")
  options Json?

  isActive Boolean @default(true)

  // Relations
  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

model Cart {
  id     String  @id @default(cuid())
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // For guest carts
  sessionId String? @unique

  // Track last activity for abandoned cart cleanup
  expiresAt DateTime?

  items         CartItem[]
  abandonedCart AbandonedCart?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([expiresAt])
  @@index([updatedAt])
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Reference to specific variant if applicable
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  quantity Int @default(1) // Validate in application: min=1, max=999

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note: NULL variantId values are treated as distinct in PostgreSQL
  // Application must prevent duplicate (cartId, productId, NULL) combinations
  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId])
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Order status
  status OrderStatus @default(PENDING)

  // Pricing (all amounts validated in application: >= 0)
  subtotal       Decimal @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  taxRate        Decimal @default(0) @db.Decimal(5, 4) // Store the tax rate used (e.g., 0.0825 for 8.25%)
  shippingAmount Decimal @default(0) @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?
  paymentIntentId String?

  // Shipping
  shippingAddressId String?
  shippingAddress   Address? @relation("ShippingAddress", fields: [shippingAddressId], references: [id], onDelete: SetNull)
  billingAddressId  String?
  billingAddress    Address? @relation("BillingAddress", fields: [billingAddressId], references: [id], onDelete: SetNull)

  trackingNumber String?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  cancelledAt    DateTime?
  refundedAt     DateTime?

  // Relations
  items         OrderItem[]
  statusHistory OrderStatusHistory[]

  // Customer info for guest orders
  customerEmail String?
  customerName  String?
  customerPhone String?

  // Gift order support
  isGift      Boolean @default(false)
  giftMessage String? @db.Text

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([customerEmail])
  @@index([status, createdAt])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  // Reference to specific variant if applicable
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Restrict)

  // Snapshot data at time of order
  productName  String
  productSlug  String
  productImage String?
  sku          String?
  variantName  String?

  quantity   Int // Validate in application: >= 1
  unitPrice  Decimal @db.Decimal(10, 2) // Validate in application: >= 0
  totalPrice Decimal @db.Decimal(10, 2) // Validate in application: >= 0

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isDefault   Boolean @default(false)
  isValidated Boolean @default(false) // Set to true after address verification service validates

  fullName   String // Validate: not empty
  company    String?
  address1   String // Validate: not empty
  address2   String?
  city       String // Validate: not empty
  state      String?
  postalCode String // Validate: format based on country
  country    String // Validate: use ISO 3166-1 alpha-2 codes (e.g., 'US', 'CA')
  phone      String? // Validate: international format E.164

  // Relations for orders
  shippingOrders Order[] @relation("ShippingAddress")
  billingOrders  Order[] @relation("BillingAddress")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
}

model Review {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating  Int // 1-5 stars (validate in application code: 1-5 range)
  title   String?
  comment String? @db.Text

  isVerifiedPurchase Boolean @default(false)
  isApproved         Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  editedAt  DateTime? // Set when review is edited after initial creation

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([isApproved])
  @@index([rating])
  @@index([productId, isApproved])
}

model OrderStatusHistory {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  fromStatus OrderStatus?
  toStatus   OrderStatus
  note       String?      @db.Text

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([createdAt])
}

model WishlistItem {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([createdAt])
}

// Enums

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum TaxType {
  SALES_TAX
  VAT
  GST
  EXEMPT
}

model TaxRate {
  id String @id @default(cuid())

  // Location identifiers (ISO codes)
  country    String // ISO 3166-1 alpha-2 (e.g., "US", "CA", "GB")
  state      String? // State/province code (e.g., "CA", "NY", "ON")
  city       String? // City name for hyper-local tax
  postalCode String? // Postal/ZIP code for very specific tax

  // Tax details
  rate        Decimal @db.Decimal(5, 4) // Tax rate (e.g., 0.0825 for 8.25%)
  type        TaxType @default(SALES_TAX)
  name        String // Display name (e.g., "California Sales Tax")
  description String? @db.Text

  // Effective dates
  startDate DateTime? // When this rate becomes effective
  endDate   DateTime? // When this rate expires

  // Priority and status
  priority Int     @default(1) // Higher priority rates override lower ones
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([country, state, city, postalCode])
  @@index([country])
  @@index([country, state])
  @@index([isActive])
  @@index([startDate, endDate])
}

model AbandonedCart {
  id String @id @default(cuid())

  // Cart reference
  cartId String @unique
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  // Customer info (for email)
  userEmail String // User email or guest email for recovery
  userName  String? // Optional user name for personalization

  // Cart snapshot (for analytics and email)
  itemCount     Int // Number of items in cart
  cartTotal     Decimal @db.Decimal(10, 2) // Total cart value
  itemsSnapshot Json // Snapshot of cart items for recovery email

  // Recovery tracking
  recoveryToken    String   @unique @default(cuid()) // Secure token for recovery link
  tokenExpiresAt   DateTime // Token expiration (typically 7 days)
  remindersSent    Int      @default(0) // Number of recovery emails sent (0-3)
  lastReminderSent DateTime? // When the last reminder was sent

  // Recovery status
  isRecovered     Boolean   @default(false) // Whether cart was recovered
  recoveredAt     DateTime? // When the cart was recovered
  orderCreated    Boolean   @default(false) // Whether an order was created
  orderId         String? // Reference to created order
  recoveryChannel String? // How it was recovered (email, manual, etc.)

  // Metadata
  abandonedAt DateTime @default(now()) // When cart was marked as abandoned
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userEmail])
  @@index([recoveryToken])
  @@index([isRecovered])
  @@index([abandonedAt])
  @@index([tokenExpiresAt])
  @@index([remindersSent])
}
